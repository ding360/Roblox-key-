// ==UserScript== 
// @name        å¹¿å‘Šé“¾æ¥åŒå¼•æ“ç»ˆæç»•è¡Œå™¨ 
// @namespace   https://github.com/ding360/Roblox-key-/new/main
// @version     1.20 
// @description åŒå¼•æ“å¹¿å‘Šé“¾æ¥ç»•è¿‡ + äººæœºéªŒè¯ç ´è§£ 
// @author      YourName 
// @match       *://*/*
// @grant       GM_xmlhttpRequest 
// @grant       GM_notification 
// @grant       GM_setClipboard 
// @grant       GM_getValue 
// @grant       GM_setValue 
// @connect     bypass.city  
// @connect     voltar.lol  
// @connect     api.yescaptcha.com  
// @require     https://code.jquery.com/jquery-3.6.0.min.js  
// @require     https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js  
// @icon        https://i.imgur.com/Sdq7sWW.png  
/* åŒ¹é…åŸŸååˆ—è¡¨ï¼ˆåŒåŸè„šæœ¬ï¼‰ */
// ==/UserScript==
 
/********************** å…¨å±€é…ç½® **********************/
const CONFIG = {
  ENGINE_PRIORITY: ["bypass_city", "voltar_lol"], // å¼•æ“ä½¿ç”¨é¡ºåº 
  CACHE_ENABLED: true,                            // å¯ç”¨ç»“æœç¼“å­˜ 
  CACHE_TTL: 60 * 60 * 1000,                      // ç¼“å­˜1å°æ—¶ 
  TIMEOUT: 10000,                                 // è¯·æ±‚è¶…æ—¶(ms)
  BYPASS_CITY_API: "https://bypass.city/api/v4",   // æ›´æ–°APIåœ°å€ 
  VOLTAR_API: "https://api.voltar.lol/v1/bypass" 
};
 
/********************** å¼•æ“ç³»ç»Ÿ **********************/
class BypassEngine {
  static engines = {
    bypass_city: {
      process: async (url) => {
        const cacheKey = `cache_${CryptoJS.MD5(url).toString()}`;
        if (CONFIG.CACHE_ENABLED) {
          const cached = GM_getValue(cacheKey);
          if (cached && (Date.now()  - cached.timestamp)  < CONFIG.CACHE_TTL) {
            return cached.result; 
          }
        }
 
        // æ–°ç‰ˆAPIè¯·æ±‚ 
        const response = await this._request({
          url: CONFIG.BYPASS_CITY_API,
          method: "POST",
          headers: { "Content-Type": "application/json" },
          data: JSON.stringify({  url })
        });
 
        // æ™ºèƒ½ç»“æœè§£æ 
        let result = null;
        try {
          // å°è¯•JSONè§£æ 
          const json = JSON.parse(response); 
          if (json.success)  result = json.direct_url; 
        } catch {
          // é™çº§åˆ°HTMLè§£æ 
          result = this._parseHTML(response);
        }
 
        // ç»“æœç¼“å­˜ 
        if (result && CONFIG.CACHE_ENABLED) {
          GM_setValue(cacheKey, { result, timestamp: Date.now()  });
        }
        return result;
      },
 
      _parseHTML: (html) => {
        const patterns = [
          { selector: 'div.result-container  > a[href]', attr: 'href' },
          { selector: 'meta[http-equiv="refresh"]', regex: /url=(.*?)(?:"|$)/ },
          { selector: 'script', regex: /window\.location\s*=\s*['"](.*?)['"]/ }
        ];
        
        const doc = new DOMParser().parseFromString(html, "text/html");
        for (const {selector, attr, regex} of patterns) {
          const element = doc.querySelector(selector); 
          if (element) {
            if (attr && element[attr]) return decodeURIComponent(element[attr]);
            if (regex && element.textContent)  {
              const match = element.textContent.match(regex); 
              if (match?.[1]) return decodeURIComponent(match[1]);
            }
          }
        }
        return null;
      }
    },
 
    voltar_lol: {
      // ...ä¿ç•™åŸæœ‰voltar.lol é€»è¾‘å¹¶ä¼˜åŒ–...
    }
  };
 
  static async processUrl(url) {
    // æŒ‰ä¼˜å…ˆçº§å°è¯•ä¸åŒå¼•æ“ 
    for (const engineName of CONFIG.ENGINE_PRIORITY) {
      try {
        const result = await this.engines[engineName]?.process(url); 
        if (result) {
          GM_notification({
            title: `âœ… ${engineName} è§£ææˆåŠŸ`,
            text: "ç‚¹å‡»æŸ¥çœ‹ç›®æ ‡é“¾æ¥",
            onclick: () => window.open(result,  "_blank")
          });
          return result;
        }
      } catch (e) {
        console.error(`${engineName} å¼•æ“å¤±è´¥:`, e);
      }
    }
    return null;
  }
 
  static _request(options) {
    return new Promise((resolve, reject) => {
      const timer = setTimeout(() => reject("è¯·æ±‚è¶…æ—¶"), CONFIG.TIMEOUT);
      
      GM_xmlhttpRequest({
        method: options.method, 
        url: options.url, 
        headers: options.headers, 
        data: options.data, 
        onload: (res) => {
          clearTimeout(timer);
          resolve(res.responseText); 
        },
        onerror: (err) => {
          clearTimeout(timer);
          reject(err);
        }
      });
    });
  }
}
 
/********************** ç”¨æˆ·ç•Œé¢ç³»ç»Ÿ **********************/
class UISystem {
  static init() {
    this._createFloatingPanel();
    this._addContextMenu();
    this._bindHotkeys();
  }
 
  static _createFloatingPanel() {
    const panelHTML = `
      <div id="bypass-panel" style="position:fixed;bottom:20px;right:20px;z-index:99999;
        background:#1a1a2e;color:#fff;border-radius:15px;padding:15px;width:300px;
        box-shadow:0 5px 25px rgba(0,0,0,0.3);font-family:'Segoe UI',sans-serif">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0;color:#64ffda">ğŸ”— é“¾æ¥ç»•è¡Œå™¨</h3>
          <span id="panel-close" style="cursor:pointer;font-size:20px">&times;</span>
        </div>
        
        <div class="engine-select" style="margin-bottom:15px">
          <label style="display:block;margin-bottom:5px;font-size:13px">ä¼˜å…ˆå¼•æ“:</label>
          <select id="engine-priority" style="width:100%;padding:8px;background:#16213e;color:#fff;border:1px solid #0d7377;border-radius:5px">
            <option value="bypass_city">Bypass.City (æ¨è)</option>
            <option value="voltar_lol">Voltar.lol</option> 
            <option value="auto">è‡ªåŠ¨é€‰æ‹©</option>
          </select>
        </div>
        
        <div class="url-input" style="margin-bottom:15px">
          <label style="display:block;margin-bottom:5px;font-size:13px">è¾“å…¥å¹¿å‘Šé“¾æ¥:</label>
          <input id="ad-url-input" type="text" style="width:100%;padding:8px;background:#16213e;color:#fff;border:1px solid #0d7377;border-radius:5px">
        </div>
        
        <button id="process-btn" style="width:100%;padding:10px;background:#0d7377;color:white;border:none;
          border-radius:25px;font-weight:bold;cursor:pointer;transition:all 0.3s">
          ğŸš€ è§£æçœŸå®é“¾æ¥ 
        </button>
        
        <div id="result-container" style="margin-top:15px;display:none">
          <hr style="border-color:#64ffda55">
          <h4 style="margin:10px 0;color:#64ffda">è§£æç»“æœ</h4>
          <div id="result-url" style="word-break:break-all;background:#16213e;padding:10px;border-radius:5px;max-height:100px;overflow-y:auto"></div>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button id="copy-btn" style="flex:1;padding:8px;background:#4a6cf7;border:none;color:white;border-radius:5px;cursor:pointer">å¤åˆ¶</button>
            <button id="visit-btn" style="flex:1;padding:8px;background:#0d7377;border:none;color:white;border-radius:5px;cursor:pointer">è®¿é—®</button>
          </div>
        </div>
      </div>
    `;
    
    $('body').append(panelHTML);
    
    // äº‹ä»¶ç»‘å®š 
    $('#panel-close').click(() => $('#bypass-panel').hide());
    $('#process-btn').click(this.processLink); 
    $('#copy-btn').click(() => {
      GM_setClipboard($('#result-url').text());
      this._showToast('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
    $('#visit-btn').click(() => window.open($('#result-url').text(),  '_blank'));
    
    // æ¢å¤ç”¨æˆ·è®¾ç½® 
    const savedEngine = GM_getValue('engine_priority', 'bypass_city');
    $('#engine-priority').val(savedEngine).change(() => {
      GM_setValue('engine_priority', $('#engine-priority').val());
    });
  }
 
  static async processLink() {
    const adUrl = $('#ad-url-input').val().trim();
    if (!adUrl) return this._showToast('âš ï¸ è¯·è¾“å…¥å¹¿å‘Šé“¾æ¥');
    
    $('#process-btn').html('ğŸ”„ è§£æä¸­...').prop('disabled', true);
    
    try {
      CONFIG.ENGINE_PRIORITY = [$('#engine-priority').val()];
      const result = await BypassEngine.processUrl(adUrl); 
      
      if (result) {
        $('#result-url').text(result);
        $('#result-container').show();
        this._showToast('âœ… è§£ææˆåŠŸ');
      } else {
        this._showToast('âŒ æ— æ³•è§£ææ­¤é“¾æ¥');
      }
    } catch (e) {
      this._showToast('âš ï¸ è§£æå‡ºé”™: ' + e.message); 
    } finally {
      $('#process-btn').html('ğŸš€ è§£æçœŸå®é“¾æ¥').prop('disabled', false);
    }
  }
  
  static _showToast(message) {
    // å®ç°Toastæç¤º...
  }
}
 
/********************** éªŒè¯ç ç ´è§£ç³»ç»Ÿ **********************/
class CaptchaSolver {
  // ...ä¿ç•™åŸæœ‰éªŒè¯ç ç ´è§£åŠŸèƒ½å¹¶å¢å¼º...
}
 
/********************** è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ **********************/
class AutoDetectSystem {
  static init() {
    this._monitorPageChanges();
    setInterval(this._scanPageLinks, 5000);
  }
  
  static _scanPageLinks() {
    $('a[href]').each(function() {
      const url = $(this).attr('href');
      if (this._isAdLink(url)) {
        $(this).css({'border': '2px solid #ff4d4d', 'border-radius': '3px'})
               .hover(
                 () => $(this).css('background-color', '#ffcccc'),
                 () => $(this).css('background-color', '')
               )
               .click(async (e) => {
                 e.preventDefault(); 
                 const result = await BypassEngine.processUrl(url); 
                 if (result) window.open(result,  '_blank');
               });
      }
    });
  }
  
  static _isAdLink(url) {
    const adDomains = ['linkvertise.com',  'adfoc.us',  'sh.st',  'boost.ink']; 
    return adDomains.some(domain  => url.includes(domain)); 
  }
}
 
/********************** ä¸»æ‰§è¡Œç³»ç»Ÿ **********************/
(function() {
  'use strict';
  
  $(document).ready(() => {
    // åˆå§‹åŒ–ç³»ç»Ÿ 
    UISystem.init(); 
    AutoDetectSystem.init(); 
    
    // æ³¨å†Œå³é”®èœå• 
    GM_registerMenuCommand("è§£æå½“å‰é¡µé¢å¹¿å‘Šé“¾æ¥", () => {
      AutoDetectSystem._scanPageLinks(true);
    });
  });
  
  // è·¨åŸŸè¯·æ±‚æƒé™ 
  GM_xmlhttpRequest({
    method: "HEAD",
    url: "https://bypass.city", 
    onload: () => console.log(" å·²è¿æ¥bypass.city"), 
    onerror: () => console.warn(" æ— æ³•è¿æ¥bypass.city") 
  });
})();
 
/********************** å£°æ˜éƒ¨åˆ† **********************/
/*
ã€æŠ€æœ¯å¢å¼ºã€‘
1. Bypass.City APIå‡çº§åˆ°v4ç‰ˆæœ¬ 
2. æ™ºèƒ½è§£æå™¨æ”¯æŒå¤šç§å“åº”æ ¼å¼ 
3. åŠ¨æ€å¼•æ“ä¼˜å…ˆçº§é…ç½® 
4. å…¨å±€ç¼“å­˜ç³»ç»Ÿæå‡æ€§èƒ½ 
 
ã€å¼•æ“æ€§èƒ½å¯¹æ¯”ã€‘
| åŠŸèƒ½                   | bypass.city  | voltar.lol  |
|------------------------|-------------|------------|
| å¤šå±‚å¹¿å‘Šè§£æ           | â˜…â˜…â˜…â˜…â˜…       | â˜…â˜…â˜…â˜†â˜†      |
| å“åº”é€Ÿåº¦               | â˜…â˜…â˜…â˜…â˜†       | â˜…â˜…â˜…â˜…â˜…      |
| ç‰¹æ®Šå¹³å°æ”¯æŒ           | â˜…â˜…â˜…â˜…â˜†       | â˜…â˜…â˜…â˜†â˜†      |
| å…è´¹ç¨³å®šæ€§             | â˜…â˜…â˜…â˜†â˜†       | â˜…â˜…â˜…â˜…â˜†      |
 
ã€ä½¿ç”¨å»ºè®®ã€‘
å½“é‡åˆ°å¤æ‚å¹¿å‘Šå¢™æ—¶ä¼˜å…ˆä½¿ç”¨bypass.city ï¼Œç®€å•è·³è½¬ä½¿ç”¨voltar.lol  
å•†ä¸šç”¨é€”å»ºè®®è´­ä¹°bypass.city çš„ä¼ä¸šAPIå¯†é’¥ 
*/
